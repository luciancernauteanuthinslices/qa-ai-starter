name: QA AI Pipeline

on:
  pull_request:
    paths:
      - "stories/**"
      - "features/**"
      - "tests/**"
      - "scripts/**"
      - "pages/**"
      - "playwright.config.*"
      - "package.json"
      - "tsconfig.json"
  push:
    branches: [ main, master ]
  schedule:
    # Nightly regression testing (Mon-Fri)
    - cron: "0 2 * * 1-5"
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - ui
          - api
          - visual

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: qa-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: CI
    env:
      BASE_URL: ${{ vars.BASE_URL || 'https://opensource-demo.orangehrmlive.com' }}
      USERNAME: ${{ secrets.USERNAME || 'Admin' }}
      PASSWORD: ${{ secrets.PASSWORD || 'admin123' }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL || 'claude-sonnet-4-20250514' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Create .env file
        run: |
          echo "BASE_URL=${{ env.BASE_URL }}" > .env
          echo "USERNAME=${{ env.USERNAME }}" >> .env
          echo "PASSWORD=${{ env.PASSWORD }}" >> .env
          echo "ANTHROPIC_API_KEY=${{ env.ANTHROPIC_API_KEY }}" >> .env
          echo "CLAUDE_MODEL=${{ env.CLAUDE_MODEL }}" >> .env

      - name: Generate features from stories
        run: npm run ai:stories
        continue-on-error: true

      - name: Generate AI specs from features
        run: npm run ai:specs:all
        continue-on-error: true

      - name: Run tests
        run: |
          case "${{ github.event.inputs.test_suite || 'default' }}" in
            "smoke")
              npx playwright test --grep "@smoke"
              ;;
            "ui")
              npx playwright test --grep "@ui"
              ;;
            "api")
              npx playwright test tests/api/
              ;;
            "visual")
              npx playwright test --grep "@visual"
              ;;
            *)
              if [ "${{ github.event_name }}" = "pull_request" ]; then
                npx playwright test --grep "@smoke"
              else
                npx playwright test
              fi
              ;;
          esac

      - name: Run performance tests
        if: github.event_name != 'pull_request'
        uses: grafana/setup-k6-action@v1

      - name: Execute k6 load test
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p reports/performance
          k6 run --vus 5 --duration 30s --out json=reports/performance/k6.json scripts/k6/load_test.js
        env:
          BASE_URL: ${{ env.BASE_URL }}
        continue-on-error: true

      - name: Generate reports
        if: always()
        run: |
          mkdir -p reports/{ui,api,summaries,performance} metrics
          npm run diff:ui || echo "UI diff skipped"
          npm run diff:api || echo "API diff skipped"
          npm run report:summary || echo "Summary generation failed"
          npm run report:kpi || echo "KPI report failed"
          npm run regression:ui || echo "UI regression skipped"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-results-${{ github.run_number }}
          path: |
            playwright-report/
            test-results/
            reports/
            metrics/
            features/
            tests/e2e/
          retention-days: 7

      - name: Create job summary
        if: always()
        run: |
          echo "# QA AI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'default' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Pipeline Steps" >> $GITHUB_STEP_SUMMARY
          echo "✅ Stories → Features (AI)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Features → Specs (AI)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "✅ Report Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f reports/summaries/last.md ]; then
            echo "## Detailed Summary" >> $GITHUB_STEP_SUMMARY
            cat reports/summaries/last.md >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No detailed summary available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📊 **Artifacts:** qa-results-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
